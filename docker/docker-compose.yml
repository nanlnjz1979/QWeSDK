services:
  redis:
    image: redis:7
    ports:
      - "6379:6379"
    volumes:
      - ./redis.conf:/etc/redis/redis.conf
    command: ["redis-server","/etc/redis/redis.conf"]

  celery:
    build:
      context: ./app
      dockerfile: Dockerfile
    image: qwesdk:latest
    working_dir: /app
    # 先运行版本检测和更新，然后启动celery worker
    command: >
      sh -c "
      python /app/qwesdk_entrypoint.py && 
      echo 'QWeSDK版本检测完成，启动celery worker...' && 
      celery -A celery_app worker --loglevel=INFO --pool=gevent --concurrency=50
      "
    volumes:
      - ./app:/app
    environment:
      - PYTHONPATH=/app
    depends_on:
      - redis


